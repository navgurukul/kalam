import{bg as N,bH as G,r as f,bD as c,aS as a,be as T,bc as h,bb as K,ba as g,bj as A,cC as W,cD as U,dv as V,bs as Z,bu as E,br as x}from"./vendor.5ff35c24.js";import{a as y}from"./vendor_axios.5abceb0c.js";import{b as z,L as J}from"./index.cb0640cd.js";import"./vendor_core_js_pure.7f605738.js";import"./vendor_react_epic_spinners.792a5510.js";import"./vendor_mui_datatables.34fc80b0.js";import"./vendor_lodash.dde4158d.js";import"./vendor_react_slick.468a9aef.js";import"./vendor_react_easy_edit.886afc3d.js";import"./vendor_react_player.223b9460.js";const Q="654022633429-hgsih4jak72ithfna2jh4ha8mg3bne4l.apps.googleusercontent.com",X="https://www.googleapis.com/auth/calendar https://www.googleapis.com/auth/calendar.events",ee="https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest";let b=null,Y=null;const B=()=>new Promise((r,s)=>{const i=document.createElement("script");i.src="https://apis.google.com/js/api.js",i.onload=()=>{window.gapi.load("client",async()=>{try{await window.gapi.client.init({discoveryDocs:[ee]}),r(!0)}catch(u){console.error("GAPI Init Error:",u),s(u)}})},i.onerror=s,document.body.appendChild(i);const m=document.createElement("script");m.src="https://accounts.google.com/gsi/client",m.async=!0,m.defer=!0,document.body.appendChild(m)}),$=()=>new Promise((r,s)=>{Y||(Y=window.google.accounts.oauth2.initTokenClient({client_id:Q,scope:X,callback:i=>{i.error?s(i):(b=i.access_token,r(b))}})),Y.requestAccessToken()}),P=async(r,s)=>(await window.gapi.client.calendar.events.list({calendarId:"primary",timeMin:r,timeMax:s,showDeleted:!1,singleEvents:!0,orderBy:"startTime"})).result.items||[],te=async(r,s)=>{try{b||await $();const m=(await P(r,s)).filter(u=>u.summary==="Auto Interview Call").map(u=>window.gapi.client.calendar.events.delete({calendarId:"primary",eventId:u.id}).then(()=>{console.log("Event deleted:",u.id)}));await Promise.all(m)}catch(i){console.error("Error deleting event:",i)}},ne=async(r,s,i)=>{try{if(b||await $(),(await P(r,s)).length>=3)return console.warn("\u274C Slot already has 3 meetings. Choose another time."),null;const u={summary:"Auto Interview Call",description:"Scheduled via Interview Portal",start:{dateTime:r,timeZone:"Asia/Kolkata"},end:{dateTime:s,timeZone:"Asia/Kolkata"},attendees:[{email:i}],conferenceData:{createRequest:{requestId:String(new Date().getTime()),conferenceSolutionKey:{type:"hangoutsMeet"}}}};return(await window.gapi.client.calendar.events.insert({calendarId:"primary",resource:u,conferenceDataVersion:1,sendUpdates:"all"})).result.hangoutLink||null}catch(m){return console.error("Error creating Meet link:",m),null}},k="https://join.navgurukul.org/api/",ge=()=>{const{enqueueSnackbar:r}=N(),{studentId:s}=G(),i=[{id:1,from:"9:00",to:"10:00"},{id:2,from:"10:00",to:"11:00"},{id:3,from:"11:00",to:"12:00"},{id:4,from:"12:00",to:"13:00"},{id:5,from:"13:00",to:"14:00"},{id:6,from:"14:00",to:"15:00"}],[m,u]=f.exports.useState(!0),[t,D]=f.exports.useState({from:"",to:"",id:null,is_cancelled:!0}),[p,j]=f.exports.useState(c()),[v,H]=f.exports.useState({}),[_,C]=f.exports.useState(i),L=15,I=e=>{const n=c(e).format("YYYY-MM-DD");j(c(e)),y.get(`${k}/slot/interview/check/ondate/${n}/1`).then(({data:o})=>{if(o.data.length){const d=c().isSame(e,"day")?o.data.filter(l=>l.availiblity&&c(`${n} ${l.from}`).isAfter(c())):o.data.filter(l=>l.availiblity);C(d)}else C(i)})},M=async()=>{var n,o,d;return(d=(o=(n=(await y.get(`${k}slot/interview/${s}`)).data)==null?void 0:n.data)==null?void 0:o[0])!=null?d:null},O=async()=>{var n,o,d;return(d=(o=(n=(await y.get(`${k}/students/${s}`)).data)==null?void 0:n.data)==null?void 0:o[0])!=null?d:null};f.exports.useEffect(()=>{(async()=>{const e=await M();e&&D(e);const n=await O();if(n){const{name:o,stage:d,lastTransition:l}=n;H({name:o,stage:z[d],transitionID:l==null?void 0:l.id}),I(p),u(!1)}})()},[]);const F=async()=>{if(!(t!=null&&t.on_date)||!(t!=null&&t.start_time)||!(t!=null&&t.end_time_expected)){r("Slot timing is invalid. Cannot delete meet event.",{variant:"error"});return}try{const e=c(t.on_date),[n,o]=t.start_time.split(":"),[d,l]=t.end_time_expected.split(":"),w=e.hour(n).minute(o).second(0).toISOString(),S=e.hour(d).minute(l).second(0).toISOString();console.log("Deleting event for:",{startTimeISO:w,endTimeISO:S}),await B(),await te(w,S);const{data:q}=await y.delete(`${k}slot/interview/stundet/${t.id}`);q.message==="Successfully inserted slot deleted"?(r("Slot Cancelled & Meet Removed",{variant:"info"}),I(p),D({is_cancelled:!0})):r("Slot Not Cancelled",{variant:"error"})}catch(e){console.error(e),r("Error deleting slot or meet",{variant:"error"})}},R=async()=>{const{from:e,to:n}=t,o=c(`${p.format("YYYY-MM-DD")} ${e}`).toISOString(),d=c(`${p.format("YYYY-MM-DD")} ${n}`).toISOString();try{await B();const l=await ne(o,d,"admissionteam@navgurukul.org"),w=await y.post(`${k}slot/interview/student`,{student_id:s,student_name:v.name,topic_name:v.stage,transition_id:v.transitionID,start_time:e,end_time_expected:n,duration:"1hr",on_date:p.format("YYYY-MM-DD"),meet_link:l});if(console.log("Booking Response:",w.data),w.data.status==="successfully_scheduled"){const S=await M();S&&D(S),r("Slot Booked & Meet Scheduled",{variant:"success"})}else throw new Error("Booking failed")}catch(l){console.error(l),r("Failed to schedule meet or book slot",{variant:"error"})}};return m?a(J,{}):["Screening Test Pass","Learning Round Pass","Pending Culture Fit Re-Interview","Interview Scheduled"].includes(v.stage)?a(K,{maxWidth:"md",sx:{bgcolor:"background.paper",p:4},children:t.is_cancelled?g(A,{children:[a(h,{variant:"h5",children:"Book Interview Slot"}),g(h,{variant:"h6",mt:2,children:["Book Interview Slot for ",v.name]}),g(T,{display:"flex",flexDirection:"column",alignItems:"center",mb:3,children:[a(W,{dateAdapter:U,children:a(V,{displayStaticWrapperAs:"desktop",value:p,onChange:I,shouldDisableDate:e=>e.isAfter(c().add(L,"day")),disablePast:!0,renderInput:e=>a(Z,{...e})})}),_.length>0?a(E,{container:!0,spacing:2,justifyContent:"center",mt:2,children:_.map(({id:e,from:n,to:o})=>a(E,{item:!0,sm:6,md:4,children:g(x,{fullWidth:!0,variant:t.id===e?"contained":"outlined",onClick:()=>D({id:e,from:n,to:o,is_cancelled:!0}),children:[c(n,"HH").format("h:mm A")," -"," ",c(o,"HH").format("h:mm A")]})},e))}):g(h,{variant:"h6",textAlign:"center",mt:2,children:["No Slots Available on ",p.format("MMM D, YYYY")]})]}),a(x,{variant:"contained",color:"primary",disabled:!t.id||_.length===0,onClick:R,children:"Book Slot"})]}):g(A,{children:[a(h,{variant:"h4",children:"Interview Slot Booked"}),a(h,{variant:"h5",mt:2,children:"Slot Details"}),g(h,{variant:"h6",mt:1,children:[a("strong",{children:"Student Name:"})," ",t.student_name]}),g(h,{variant:"h6",children:[a("strong",{children:"Topic:"})," ",t.topic_name]}),g(h,{variant:"h6",children:[a("strong",{children:"On:"})," ",c(t.on_date).format("D MMM YYYY")]}),g(h,{variant:"h6",children:[a("strong",{children:"From:"})," ",c(t.start_time,"HH").format("h:mm A")," ",a("strong",{children:"To:"})," ",c(t.end_time_expected,"HH").format("h:mm A")]}),a(x,{variant:"contained",color:"primary",sx:{mt:3},onClick:F,children:"Reschedule Slot"})]})}):a(T,{display:"flex",justifyContent:"center",children:a(h,{variant:"h4",color:"primary",children:"You cannot book slot"})})};export{ge as default};
